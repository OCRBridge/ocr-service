name: Docker Image CI

on:
  push:
    branches: [ "main" ]
    tags:
      - 'v*.*.*'  # Build full on version tags
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:  # Allow manual triggering for full builds
    inputs:
      build_full:
        description: 'Build full flavor (lite always builds)'
        required: false
        type: boolean
        default: false

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - flavor: lite
            target: lite
            description: "Tesseract-only (lightweight)"
            size: "~500MB"
            always_build: true  # Lite always builds
          - flavor: full
            target: full
            description: "Tesseract + EasyOCR (with GPU support)"
            size: "~2.5GB"
            always_build: false  # Full is conditional

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.flavor }} Docker image
        # Conditional: Skip full flavor on PRs unless manually triggered
        if: |
          matrix.always_build ||
          github.event_name == 'workflow_dispatch' && inputs.build_full ||
          startsWith(github.ref, 'refs/tags/v') ||
          github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          target: ${{ matrix.target }}
          push: false
          tags: |
            ocr-service:${{ matrix.flavor }}
            ocr-service:${{ matrix.flavor }}-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build summary
        if: |
          matrix.always_build ||
          github.event_name == 'workflow_dispatch' && inputs.build_full ||
          startsWith(github.ref, 'refs/tags/v') ||
          github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "âœ… Successfully built ${{ matrix.flavor }} image (${{ matrix.description }})"
          echo "   Target: ${{ matrix.target }}"
          echo "   Size: ${{ matrix.size }}"
          echo "   Tags: ocr-service:${{ matrix.flavor }}, ocr-service:${{ matrix.flavor }}-${{ github.sha }}"
          echo "   Trigger: ${{ github.event_name }}"

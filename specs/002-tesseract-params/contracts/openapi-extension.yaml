# OpenAPI 3.1 Extension for Tesseract Parameters Feature
# Feature: 002-tesseract-params
# Date: 2025-10-18
#
# This document defines the API contract extensions for configurable Tesseract parameters.
# It extends the existing /api/v1/upload endpoint with optional parameters.

openapi: 3.1.0
info:
  title: RESTful OCR API - Tesseract Parameters Extension
  version: 1.1.0
  description: |
    Extension to the OCR API adding configurable Tesseract parameters (language, PSM, OEM, DPI).
    All parameters are optional and maintain backward compatibility with existing clients.

paths:
  /api/v1/upload:
    post:
      summary: Upload document for OCR processing with optional Tesseract parameters
      description: |
        Upload a document for OCR processing. Optionally specify Tesseract configuration
        parameters to customize recognition for specific languages, document layouts, and
        image resolutions.

        **Default Behavior (no parameters):**
        - Language: English (`eng`)
        - PSM: 3 (Fully automatic page segmentation)
        - OEM: 3 (Default based on available traineddata)
        - DPI: Auto-detect from image metadata or 70

        **Common Use Cases:**
        - French document: `lang=fra`
        - Invoice/form: `lang=eng&psm=6&oem=1&dpi=300`
        - Receipt: `lang=eng&psm=11&oem=1&dpi=300`
        - Multi-language: `lang=eng+fra+deu`

      operationId: uploadDocumentWithParams
      tags:
        - OCR

      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                  description: Document file to process (JPEG, PNG, PDF, TIFF)

                lang:
                  type: string
                  pattern: '^[a-z]{3}(\+[a-z]{3})*$'
                  description: |
                    Language code(s) for OCR recognition. Use 3-letter ISO 639-2/3 codes.
                    Multiple languages can be specified using `+` separator.
                    Maximum 5 languages per request.

                    **Common codes:**
                    - `eng` - English
                    - `fra` - French
                    - `deu` - German
                    - `spa` - Spanish
                    - `ita` - Italian
                    - `por` - Portuguese
                    - `rus` - Russian
                    - `ara` - Arabic
                    - `chi_sim` - Simplified Chinese
                    - `jpn` - Japanese

                    **Examples:**
                    - `eng` - English only
                    - `eng+fra` - English and French
                    - `eng+fra+deu` - English, French, and German
                  example: "eng"
                  nullable: true

                psm:
                  type: integer
                  minimum: 0
                  maximum: 13
                  description: |
                    Page Segmentation Mode - controls how Tesseract segments the page.

                    **Common modes:**
                    - `3` - Fully automatic (default) - best for most documents
                    - `6` - Single uniform block - best for tables, invoices, structured forms
                    - `7` - Single text line - best for single-line form fields
                    - `11` - Sparse text - best for receipts with scattered text

                    **All modes:**
                    - `0` - Orientation and script detection (OSD) only (no OCR)
                    - `1` - Automatic page segmentation with OSD
                    - `2` - Automatic page segmentation (no OSD or OCR)
                    - `3` - Fully automatic page segmentation (default)
                    - `4` - Single column of variable-sized text
                    - `5` - Single uniform block of vertically aligned text
                    - `6` - Single uniform block of text
                    - `7` - Treat image as single text line
                    - `8` - Treat image as single word
                    - `9` - Treat image as single word in a circle
                    - `10` - Treat image as single character
                    - `11` - Sparse text - find text in any order
                    - `12` - Sparse text with OSD
                    - `13` - Raw line - bypass Tesseract-specific hacks
                  example: 3
                  nullable: true

                oem:
                  type: integer
                  minimum: 0
                  maximum: 3
                  description: |
                    OCR Engine Mode - controls which Tesseract engine to use.

                    **Modes:**
                    - `0` - Legacy engine only (faster, lower accuracy)
                    - `1` - LSTM neural network only (recommended - best accuracy)
                    - `2` - Legacy + LSTM combined (slower)
                    - `3` - Default (auto-select based on available traineddata)

                    **Recommendation:** Use `1` (LSTM) for modern Tesseract 5.x installations.
                  example: 1
                  nullable: true

                dpi:
                  type: integer
                  minimum: 70
                  maximum: 2400
                  description: |
                    Image resolution (dots per inch) for OCR processing.
                    Overrides missing or incorrect DPI metadata in image files.

                    **Typical values:**
                    - `150` - Low resolution scans
                    - `300` - Standard document scans (most common)
                    - `600` - High-quality scans for small text

                    **When to specify:**
                    - Image lacks DPI metadata (Tesseract warns about "Invalid resolution 0 dpi")
                    - Override incorrect metadata
                    - Standardize processing across images with inconsistent metadata
                  example: 300
                  nullable: true

            examples:
              default:
                summary: Default (English, automatic segmentation)
                value:
                  file: <binary>

              french-document:
                summary: French document
                value:
                  file: <binary>
                  lang: fra

              invoice-optimal:
                summary: Invoice with optimal settings
                value:
                  file: <binary>
                  lang: eng
                  psm: 6
                  oem: 1
                  dpi: 300

              multi-language:
                summary: Multi-language document (English + French)
                value:
                  file: <binary>
                  lang: eng+fra
                  psm: 3
                  oem: 1

              receipt:
                summary: Receipt with scattered text
                value:
                  file: <binary>
                  lang: eng
                  psm: 11
                  oem: 1
                  dpi: 300

      responses:
        '202':
          description: Job created successfully, processing started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResponse'
              example:
                job_id: "550e8400-e29b-41d4-a716-446655440000"
                status: "pending"
                status_url: "/api/v1/jobs/550e8400-e29b-41d4-a716-446655440000"

        '400':
          description: Invalid parameters or file
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
              examples:
                invalid-language:
                  summary: Language not installed
                  value:
                    detail:
                      - field: lang
                        message: "Language(s) not installed: xyz. Available: ara, chi_sim, deu, eng, fra, hin, ita, jpn, por, rus..."
                        type: value_error
                        input: "eng+xyz"

                invalid-psm:
                  summary: PSM out of range
                  value:
                    detail:
                      - field: psm
                        message: "Input should be 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12 or 13"
                        type: literal_error
                        input: 99

                too-many-languages:
                  summary: Too many languages specified
                  value:
                    detail:
                      - field: lang
                        message: "Maximum 5 languages allowed, got 6"
                        type: value_error
                        input: "eng+fra+deu+spa+ita+por"

                invalid-format:
                  summary: Invalid language code format
                  value:
                    detail:
                      - field: lang
                        message: "String should match pattern '^[a-z]{3}(\\+[a-z]{3})*$'"
                        type: string_pattern_mismatch
                        input: "ENG"

                dpi-out-of-range:
                  summary: DPI out of valid range
                  value:
                    detail:
                      - field: dpi
                        message: "Input should be greater than or equal to 70"
                        type: greater_than_equal
                        input: 50

        '415':
          description: Unsupported file format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                detail: "Unsupported file format. Supported formats: JPEG, PNG, PDF, TIFF"

        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                detail: "Rate limit exceeded. Please try again later."

components:
  schemas:
    JobResponse:
      type: object
      required:
        - job_id
        - status
        - status_url
      properties:
        job_id:
          type: string
          format: uuid
          description: Unique identifier for the OCR job
          example: "550e8400-e29b-41d4-a716-446655440000"
        status:
          type: string
          enum: [pending, processing, completed, failed]
          description: Current job status
          example: "pending"
        status_url:
          type: string
          format: uri-reference
          description: URL to check job status and retrieve results
          example: "/api/v1/jobs/550e8400-e29b-41d4-a716-446655440000"

    ValidationErrorResponse:
      type: object
      required:
        - detail
      properties:
        detail:
          type: array
          items:
            $ref: '#/components/schemas/ParameterValidationError'

    ParameterValidationError:
      type: object
      required:
        - field
        - message
        - type
      properties:
        field:
          type: string
          description: Parameter name that failed validation
          example: "lang"
        message:
          type: string
          description: Human-readable error message
          example: "Language(s) not installed: xyz. Available: eng, fra, deu..."
        type:
          type: string
          description: Error type identifier
          example: "value_error"
        input:
          description: The invalid input value provided
          example: "eng+xyz"
        context:
          type: object
          description: Additional context about the error
          nullable: true

    ErrorResponse:
      type: object
      required:
        - detail
      properties:
        detail:
          type: string
          description: Error message
          example: "Unsupported file format"

  securitySchemes: {}

security: []

tags:
  - name: OCR
    description: OCR document processing operations
